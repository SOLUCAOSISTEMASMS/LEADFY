{% extends 'base.html' %}

{% block titulo %}
  Funcionários
{% endblock %}

{% block conteudo %}
<div class="container-fluid mt-4">
  <form method="GET" action="{{ url_for('listar_funcionarios') }}" class="row g-2 mb-3 align-items-end">
    <div class="col-md-5">
      <input type="text" name="busca" class="form-control" placeholder="Buscar por nome, cargo ou email">
    </div>
    <div class="col-md-auto">
      <button type="submit" class="btn btn-outline-primary" data-bs-toggle="tooltip" title="Buscar funcionário">
        <i class="bi bi-search"></i> Buscar
      </button>
    </div>
    <div class="col-md-auto ms-auto">
      <a href="{{ url_for('criar_usuario') }}" class="btn btn-primary" data-bs-toggle="tooltip" title="Cadastrar novo funcionário">
        <i class="bi bi-person-plus-fill"></i> Novo Funcionário
      </a>
    </div>
  </form>

  <h3 class="d-flex align-items-center mb-4" style="font-weight: 600; font-size: 1.75rem;">
    <span class="badge text-dark me-2" style="background-color: #A7F7E9; font-size: 1.4rem;">
      <i class="bi bi-person-lines-fill"></i>
    </span>
    Lista de Funcionários
  </h3>

  {% if funcionarios %}
    <table class="table table-hover table-bordered align-middle table-theme-azul-claro">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Login</th>
          <th>Email</th>
          <th>Tipo</th>
          <th>Status</th>
          <th class="text-center">Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for u in funcionarios %}
          <tr>
            <td>{{ u.nome }}</td>
            <td>{{ u.nome_usuario }}</td>
            <td>{{ u.email }}</td>
            <td><span class="badge bg-info text-dark">{{ u.tipo }}</span></td>
            <td>
              {% if u.ativo %}
                <span class="badge bg-success">Ativo</span>
              {% else %}
                <span class="badge bg-secondary">Inativo</span>
              {% endif %}
            </td>
            <td class="text-center">
              <div class="btn-group" role="group">
                {% if current_user.tipo == 'admin' %}
                  <a href="/alternar_status/{{ u.id }}" class="btn btn-sm {% if u.ativo %}btn-warning{% else %}btn-success{% endif %}"
                     data-bs-toggle="tooltip" title="{% if u.ativo %}Inativar funcionário{% else %}Reativar funcionário{% endif %}">
                    <i class="bi bi-toggle-on"></i> {% if u.ativo %}Inativar{% else %}Reativar{% endif %}
                  </a>
                {% else %}
                  <button type="button" class="btn btn-sm {% if u.ativo %}btn-warning{% else %}btn-success{% endif %}"
                          data-bs-toggle="tooltip" title="Ação restrita"
                          onclick="Swal.fire({
                            icon: 'warning',
                            title: 'Acesso negado',
                            text: 'Você não tem permissão para alterar o status de funcionários.',
                            confirmButtonText: 'Entendi'
                          })">
                    <i class="bi bi-lock-fill"></i> {% if u.ativo %}Inativar{% else %}Reativar{% endif %}
                  </button>
                {% endif %}

                {% if current_user.tipo in ['admin', 'gerente'] %}
                  <a href="{{ url_for('editar_usuario', id=u.id) }}"
                     class="btn btn-sm btn-primary"
                     data-bs-toggle="tooltip" title="Editar dados do funcionário">
                    <i class="bi bi-pencil-square"></i>
                  </a>
                {% else %}
                  <button type="button" class="btn btn-sm btn-secondary"
                          data-bs-toggle="tooltip" title="Ação restrita"
                          onclick="Swal.fire({
                            icon: 'warning',
                            title: 'Acesso negado',
                            text: 'Você não tem permissão para editar funcionários.',
                            confirmButtonText: 'Entendi'
                          })">
                    <i class="bi bi-lock-fill"></i>
                  </button>
                {% endif %}
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="alert alert-warning">Nenhum funcionário cadastrado ainda.</div>
  {% endif %}

  {% with messages = get_flashed_messages(category_filter=["success"]) %}
    {% if messages %}
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          Swal.fire({
            icon: 'success',
            title: 'Funcionário atualizado!',
            text: '✅ Os dados foram salvos com sucesso.',
            confirmButtonText: 'OK'
          });
        });
      </script>
    {% endif %}
  {% endwith %}
</div>

<!-- Scripts adicionais -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
  });
</script>
{% endblock %}