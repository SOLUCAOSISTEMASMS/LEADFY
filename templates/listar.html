{% extends 'base.html' %}
{% block titulo %}Lista de Leads{% endblock %}
{% block conteudo %}

<div class="container-fluid mt-4">
  <!-- ðŸ” Filtro de busca -->
  <form method="GET" action="{{ url_for('listar') }}" class="row g-2 mb-3 align-items-end">
    <div class="col-md-5">
      <input type="text" name="busca" class="form-control" placeholder="Buscar por cliente, origem ou status" value="{{ request.args.get('busca', '') }}">
    </div>
    <div class="col-md-auto">
      <button type="submit" class="btn btn-outline-primary">
        <i class="bi bi-search"></i> Buscar
      </button>
    </div>
    <ul class="nav nav-tabs mb-3" id="abasLeads">
  <li class="nav-item">
    <a class="nav-link {% if not arquivados %}active{% endif %}" href="{{ url_for('listar') }}">
      <i class="bi bi-people-fill"></i> Ativos
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if arquivados %}active{% endif %}" href="{{ url_for('listar', arquivados=1) }}">
      <i class="bi bi-folder2"></i> Arquivados
    </a>
  </li>
</ul>
    
    <div class="col-md-auto ms-auto">
      <a href="{{ url_for('criar_lead') }}" class="btn btn-primary">
        <i class="bi bi-person-plus-fill"></i> Novo Lead
      </a>
    </div>
  </form>

  <!-- ðŸ“‹ TÃ­tulo -->
  <h3 class="d-flex align-items-center mb-2" style="font-weight: 600; font-size: 1.75rem;">
    <span class="badge text-white me-2" style="background-color: #d87474; font-size: 1.4rem;">
      <i class="bi bi-person-lines-fill"></i>
    </span>
    Lista de Leads
  </h3>
  <button class="btn btn-outline-warning btn-sm" id="btnArquivarSelecionados">
  <i class="bi bi-box-arrow-down"></i> Arquivar selecionados
</button>

  <!-- ðŸ”„ Filtro por status -->
  <div class="d-flex align-items-center justify-content-between mb-4 flex-wrap gap-2">
    <form method="GET" action="{{ url_for('listar') }}" class="mb-0">
      <select name="status" class="form-select form-select-sm w-auto" onchange="this.form.submit()">
        <option value="">Todos os Status</option>
        {% for s in todos_status %}
          <option value="{{ s.nome }}" {% if status == s.nome %}selected{% endif %}>{{ s.nome }}</option>
        {% endfor %}
      </select>
    </form>
  </div>

  {% if leads %}
    <div class="table-responsive">
      <table id="tabela-leads" class="table table-striped table-hover align-middle table-theme-verde-menta w-100">
<thead>
  <tr>
    <th><input type="checkbox" id="selecionarTodos"></th>
    <th>Cliente</th>
    <th>Produtos</th>
    <th>Origem</th>
    <th>Status</th>
    <th>Valor (R$)</th>
    <th>Dt. Retorno</th>
    <th>Dt. Cadastro</th>
    <th><i class="bi bi-person-fill"></i> Resp.</th>
    <th class="text-center">AÃ§Ãµes</th>
  </tr>
</thead>
<tbody>
  {% for lead in leads %}
  
    <tr>
      <td><input type="checkbox" class="lead-checkbox" value="{{ lead.id }}"></td>

              <td>{{ lead.cliente.nome_fantasia }}</td>
              <td>
                {% if lead.produtos %}
                  <ul class="list-unstyled mb-0">
                    {% for produto in lead.produtos %}
                      <li>{{ produto.nome }}</li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <span class="text-muted">â€”</span>
                {% endif %}
              </td>
              <td>{{ lead.origem.nome }}</td>
              <td><span class="badge text-white" style="background-color: {{ lead.status.cor or '#6c757d' }};">{{ lead.status.nome }}</span></td>
              <td>
                {% if lead.valor_personalizado %}
                  R$ {{ "%.2f"|format(lead.valor_personalizado) }}
                {% else %}
                  <span class="text-muted">â€”</span>
                {% endif %}
              </td>
              <td>
  {% if lead.data_retorno %}
    {% if lead.data_retorno < hoje %}
      <span class="badge bg-danger">{{ lead.data_retorno.strftime('%d/%m/%Y') }}</span>
    {% elif lead.data_retorno == current_date %}
      <span class="badge bg-warning text-dark">{{ lead.data_retorno.strftime('%d/%m/%Y') }}</span>
      <i class="bi bi-exclamation-triangle-fill text-danger ms-1" title="Retorno marcado para hoje"></i>
    {% else %}
      {{ lead.data_retorno.strftime('%d/%m/%Y') }}
    {% endif %}
  {% else %}
    <span class="text-muted">Sem retorno agendado</span>
  {% endif %}
</td>
              <td>
                {% if lead.data_cadastro %}
                  <span class="badge bg-info text-dark">{{ lead.data_cadastro.strftime('%d/%m/%Y') }}</span>
                {% else %}
                  <span class="text-muted">â€”</span>
                {% endif %}
              </td>
              <td>
                {% set cor_map = {'admin': 'danger', 'gerente': 'primary', 'vendedor': 'warning'} %}
                {% set cor = cor_map.get(lead.criado_por.tipo, 'success') %}
                <span class="badge bg-info text-dark border border-info">
                  <i class="bi bi-person-fill"></i>
                  {% if lead.criado_por_id == current_user.id %}
                    VocÃª
                  {% else %}
                    {{ lead.criado_por.nome_usuario }}
                  {% endif %}
                </span>
              </td>
              <td class="text-center">
                <a href="{{ url_for('editar_lead', id=lead.id) }}" class="btn btn-sm btn-warning me-1" title="Editar">
                  <i class="bi bi-pencil"></i>
                </a>
                <a href="{{ url_for('detalhes_lead', lead_id=lead.id) }}" class="btn btn-sm btn-info me-1" title="Detalhes">
                  <i class="bi bi-eye-fill"></i>
                </a>
                
                <a href="{{ url_for('nova_atividade', lead_id=lead.id) }}" class="btn btn-sm btn-success me-1" title="Atividade">
                  <i class="bi bi-journal-plus"></i>
                </a>
                {% if lead.arquivado %}
  <button type="button" class="btn btn-sm btn-outline-secondary me-1" title="Desarquivar"
    onclick="desarquivarLead('{{ lead.id }}')">
    <i class="bi bi-folder-symlink text-secondary"></i>
  </button>
{% endif %}
                <button type="button" class="btn btn-sm btn-danger" title="Excluir"
                  onclick="confirmarExclusao('{{ url_for('excluir_lead', lead_id=lead.id) }}')">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-warning text-center">Nenhum lead cadastrado ainda.</div>
  {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>const csrfToken = "{{ form.csrf_token._value() }}";</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  $(document).ready(function () {
    // ðŸ“‹ InicializaÃ§Ã£o da DataTable
    $('#tabela-leads').DataTable({
      order: [[5, 'desc']],
      searching: false,
      language: {
        url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
      },
      columnDefs: [{ targets: [8], orderable: false }]
    });

    // ðŸ—‘ï¸ ConfirmaÃ§Ã£o de exclusÃ£o
    window.confirmarExclusao = function (url) {
      Swal.fire({
        title: 'Tem certeza?',
        text: 'Esta aÃ§Ã£o vai excluir o lead permanentemente.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sim, excluir',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          const form = document.createElement('form');
          form.action = url;
          form.method = 'POST';

          // ðŸ›¡ï¸ Token CSRF
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'csrf_token';
          csrfInput.value = csrfToken;
          form.appendChild(csrfInput);

          document.body.appendChild(form);
          form.submit();
        }
      });
    };
  });
  // âœ… Checkbox global
document.getElementById('selecionarTodos').addEventListener('change', function () {
  document.querySelectorAll('.lead-checkbox').forEach(cb => {
    cb.checked = this.checked;
  });
});

// ðŸ“¦ Arquivamento em massa
document.getElementById('btnArquivarSelecionados').addEventListener('click', async () => {
  const ids = Array.from(document.querySelectorAll('.lead-checkbox:checked')).map(cb => parseInt(cb.value));

  if (ids.length === 0) {
    Swal.fire({ icon: 'info', title: 'Nenhum lead selecionado', text: 'Selecione ao menos um.', confirmButtonText: 'OK' });
    return;
  }

  const confirmacao = await Swal.fire({
  title: 'Arquivar Leads',
  html: `
    <p>VocÃª estÃ¡ arquivando <strong>${ids.length}</strong> lead(s).</p>
    <textarea id="motivoArquivamento" class="swal2-textarea" placeholder="Digite o motivo do arquivamento" rows="3"></textarea>
  `,
  icon: 'warning',
  showCancelButton: true,
  confirmButtonColor: '#d33',
  cancelButtonColor: '#6c757d',
  confirmButtonText: 'Arquivar',
  cancelButtonText: 'Cancelar',
  preConfirm: () => {
    const motivo = document.getElementById('motivoArquivamento').value.trim();
    if (!motivo) {
      Swal.showValidationMessage('Por favor, informe o motivo do arquivamento.');
    }
    return motivo;
  }
});

if (!confirmacao.isConfirmed) return;

const motivo = confirmacao.value;

  try {
    const res = await fetch('/lead/api/arquivar-multiplos', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({ ids, motivo })
    });

    if (res.ok) {
      Swal.fire({ icon: 'success', title: 'Leads arquivados!', text: 'Arquivamento realizado com sucesso.', confirmButtonText: 'OK' })
        .then(() => window.location.reload());
    } else {
      const erro = await res.json();
      Swal.fire({ icon: 'error', title: 'Erro ao arquivar', text: erro.mensagem || 'Erro desconhecido.', confirmButtonText: 'OK' });
    }
  } catch (err) {
    Swal.fire({ icon: 'error', title: 'Erro inesperado', text: 'Verifique sua conexÃ£o ou tente novamente.', confirmButtonText: 'Fechar' });
  }
});
function desarquivarLead(id) {
  Swal.fire({
    title: 'Desarquivar Lead',
    text: 'Deseja mover este lead de volta para os ativos?',
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#198754',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'Sim, desarquivar',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (!result.isConfirmed) return;

    fetch(`/lead/api/desarquivar/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      }
    }).then(async res => {
      if (res.ok) {
        Swal.fire({
          icon: 'success',
          title: 'Lead desarquivado!',
          text: 'O lead foi movido para a lista de ativos.',
          confirmButtonText: 'OK'
        }).then(() => window.location.reload());
      } else {
        const erro = await res.json();
        Swal.fire({
          icon: 'error',
          title: 'Erro ao desarquivar',
          text: erro.mensagem || 'NÃ£o foi possÃ­vel desarquivar o lead.',
          confirmButtonText: 'OK'
        });
      }
    }).catch(() => {
      Swal.fire({
        icon: 'error',
        title: 'Erro de conexÃ£o',
        text: 'Verifique sua internet e tente novamente.',
        confirmButtonText: 'Fechar'
      });
    });
  });
}
</script>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <script>
        Swal.fire({
          icon: '{{ category if category != "warning" else "warning" }}',
          title: '{{ "AtenÃ§Ã£o!" if category == "warning" else "ConcluÃ­do!" }}',
          text: '{{ message if message != "lead_atualizado" else "O lead foi atualizado com sucesso." }}',
          confirmButtonColor: '{{ "#d33" if category == "warning" else "#3085d6" }}',
          confirmButtonText: 'OK'
        });
      </script>
    {% endfor %}
  {% endif %}
{% endwith %}
{% endblock %}